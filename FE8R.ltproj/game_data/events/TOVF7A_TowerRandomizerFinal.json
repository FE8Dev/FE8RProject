[
    {
        "name": "TowerRandomizerFinal",
        "trigger": "level_start",
        "level_nid": "TOVF7A",
        "condition": "True",
        "commands": [],
        "only_once": false,
        "priority": 20,
        "_source": [
            "#pyev1",
            "import random",
            "$chapter_title",
            "enemyunitsall=game.get_enemy_units(False)",
            "for i in range(len(enemyunitsall)): ",
            "    $change_team enemyunitsall[i] \"enemy2\"",
            "#Generate variables",
            "items=['Fiery_Fang','Poison_Claw','Poison_Axe','Iron_Sword','Iron_Axe','Iron_Bow','Iron_Lance','Hand_Axe','Evil_Eye']",
            "swords=['Scorch_Sword','Wind Sword','Splash_Sword','Frost_Sword','Levin_Sword','Stone_Blade','Light_Sword','Dark_Sword']",
            "lances=['Flame_Lance','Air_Lance','Stream_Lance','Ice_Lance','Levin_Spear','Log','Holy_Lance','Dark_Spear']",
            "axes=['Fire_Axe', 'Wing_Axe', 'Water_Axe', 'Ice_Axe', 'Thunder_Axe', 'Stone_Axe', 'Holy_Axe', 'Dark_Axe']",
            "bows=['Fire_Bow', 'Wind_Bow', 'Water_Bow', 'Ice_Bow', 'Thunder_Bow', 'Earth_Bow', 'Light_Bow', 'Dark_Bow']",
            "classes=['Sword_Wight','Bow_Wight','Entombed','Arch_Mogall','Gwyllgi','Maelduin','Deathgoyle','Elder_Bael']",
            "drops=['Thunder_Scroll','Crossbow_Scroll','Energy_Ring_Consumable','Balance_Belt','Looking_Glass']",
            "pnone=.97",
            "enemyunits=game.get_enemy_units()",
            "bossunit=random.randint(0,len(enemyunits)-1)",
            "equippable_items = {",
            "    'Sword_Wight': ['Iron_Lance','Iron_Sword'],",
            "    'Bow_Wight': ['Iron_Bow'],",
            "    'Entombed': ['Poison_Claw'],",
            "    'Arch_Mogall': ['Evil_Eye'],",
            "    'Gwyllgi': ['Fiery_Fang'],",
            "    'Maelduin': ['Poison_Axe'],",
            "    'Deathgoyle': ['Iron_Lance'],",
            "    'Elder_Bael': ['Poison_Claw'],",
            "}",
            "#Randomize positions",
            "for i in range(len(enemyunits)):",
            "    $move_unit enemyunits[i].nid (enemyunits[i].position[0]+random.randint(-1,1),enemyunits[i].position[1]+random.randint(-1,1)) \"immediate\" \"closest\",no_block",
            "#Ensure created generics get a random weapon they can use   ",
            "    unit_class1 = random.choice(classes)",
            "    unit_class2 = random.choice(classes)",
            "    valid_items1 = equippable_items.get(unit_class1, [])",
            "    valid_items2 = equippable_items.get(unit_class2, [])",
            "    if valid_items1:",
            "        selected_item1 = random.choice(valid_items1)",
            "    else:",
            "        selected_item1 = None ",
            "    if valid_items2:",
            "        selected_item2 = random.choice(valid_items2)",
            "    else:",
            "        selected_item2 = None ",
            "    ",
            "#Add generics with random class, level, and item",
            "",
            "    $make_generic str(i) unit_class1 random.randint(13, 17) \"enemy2\" \"Defend\" \"Monster\" ItemList=[selected_item1]     ",
            "    $make_generic str(i+200) unit_class2 random.randint(13, 17) \"enemy2\" \"Defend\" \"Monster\" ItemList=[selected_item2] ",
            "    $add_unit str(i) enemyunits[i].nid \"immediate\" \"closest\"",
            "    if selected_item1==\"Iron_Bow\":",
            "        $remove_item str(i) selected_item1,no_banner",
            "        $give_item str(i) random.choice(bows),no_banner",
            "    elif selected_item1==\"Iron_Lance\":",
            "        $remove_item str(i) selected_item1,no_banner",
            "        $give_item str(i) random.choice(lances),no_banner",
            "    elif selected_item1==\"Poison_Axe\":",
            "        $remove_item str(i) selected_item1,no_banner",
            "        $give_item str(i) random.choice(axes),no_banner",
            "    elif selected_item1==\"Iron_Sword\":",
            "        $remove_item str(i) selected_item1,no_banner",
            "        $give_item str(i) random.choice(swords),no_banner",
            "        ",
            "    if i == bossunit:",
            "        $add_tag str(i) \"Boss\"",
            "#Generate paired up enemies    ",
            "    pairuprandom=random.randint(1,100)",
            "    if pairuprandom<16:",
            "        $add_unit str(i+200) enemyunits[i].nid \"immediate\" \"closest\"",
            "        if selected_item2==\"Iron_Bow\":",
            "            $remove_item str(i+200) selected_item2,no_banner",
            "            $give_item str(i+200) random.choice(bows),no_banner",
            "        elif selected_item2==\"Iron_Lance\":",
            "            $remove_item str(i+200) selected_item2,no_banner",
            "            $give_item str(i+200) random.choice(lances),no_banner",
            "        elif selected_item2==\"Poison_Axe\":",
            "            $remove_item str(i+200) selected_item2,no_banner",
            "            $give_item str(i+200) random.choice(axes),no_banner",
            "        elif selected_item2==\"Iron_Sword\":",
            "            $remove_item str(i+200) selected_item2,no_banner",
            "            $give_item str(i+200) random.choice(swords),no_banner",
            "        if random.random() < pnone:",
            "            $give_item str(i+200) random.choice([None])",
            "        else: ",
            "            $give_item str(i+200) random.choice(drops),droppable no_banner",
            "        $pair_up str(i) str(i+200)",
            "#Assign random drops",
            "    if random.random() >= pnone:",
            "        $give_item str(i) random.choice(drops),droppable no_banner",
            "#Clean up original units                  ",
            "    $remove_unit enemyunits[i].nid \"immediate\""
        ],
        "nid": "TOVF7A TowerRandomizerFinal"
    }
]